name: "Terraform Security Analysis"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-security.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-security.yml'
  schedule:
    - cron: '30 2 * * 1'  # Mondays at 2:30 AM UTC

jobs:
  terraform-security:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        # Pin to a Terraform version that supports "check" blocks
        terraform_version: '1.6.0'

    - name: Show Terraform version
      run: terraform -v

    - name: Terraform Format Check
      run: terraform fmt -check -recursive terraform/
      continue-on-error: true

    - name: Terraform Validate
      run: |
        cd terraform
        terraform init -backend=false
        terraform validate
      # temporary: don't fail the job while you iterate on provider/TF version issues.
      # Remove this once validate is fixed and CI should enforce it.
      continue-on-error: true

    - name: Run tfsec
      id: tfsec
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: terraform
        soft_fail: true
        format: sarif
        additional_args: --exclude-downloaded-modules --exclude-path main.tf

    - name: Check tfsec SARIF
      id: tfsec-check
      run: |
        if [ -f tfsec.sarif ]; then echo "exists=true" >> $GITHUB_OUTPUT; else echo "exists=false" >> $GITHUB_OUTPUT; fi

    - name: Upload tfsec results to GitHub Security tab
      if: steps.tfsec-check.outputs.exists == 'true'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: tfsec.sarif

    - name: Run Trivy vulnerability scanner in IaC mode
      id: trivy
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-type: 'config'
        scan-ref: 'terraform'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Check trivy SARIF
      id: trivy-check
      run: |
        if [ -f trivy-results.sarif ]; then echo "exists=true" >> $GITHUB_OUTPUT; else echo "exists=false" >> $GITHUB_OUTPUT; fi

    - name: Upload Trivy scan results to GitHub Security tab
      if: steps.trivy-check.outputs.exists == 'true'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Checkov action
      id: checkov
      uses: bridgecrewio/checkov-action@v12.3059.0
      with:
        directory: terraform
        quiet: true
        soft_fail: true
        framework: terraform
        output_format: sarif
        output_file_path: reports/results.sarif

    - name: Check Checkov SARIF
      id: checkov-check
      run: |
        if [ -f reports/results.sarif ]; then echo "exists=true" >> $GITHUB_OUTPUT; else echo "exists=false" >> $GITHUB_OUTPUT; fi

    - name: Upload Checkov results to GitHub Security tab
      if: steps.checkov-check.outputs.exists == 'true'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: reports/results.sarif